{{ if .Values.elasticsearch.in_cluster }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-curator
  labels:
{{- include "logging.labels" . | indent 2}}
data:
  actions.yml: |+
    actions:
      1:
        action: delete_indices
        description: >-
          Delete indices older than 7 days (based on index creation_date).
          Ignore the error if the filter does not result in an
          actionable list of indices (ignore_empty_list) and exit cleanly.
        options:
          ignore_empty_list: True
          timeout_override:
          continue_if_exception: False
          disable_action: False
        filters:
        - filtertype: age
          source: creation_date
          direction: older
          timestring: '%Y.%m.%d'
          unit: days
          unit_count: 7
          exclude:
        - filtertype: kibana
          exclude: True
        - filtertype: pattern
          kind: prefix
          value: .opendistro
          exclude: True
        - filtertype: pattern
          kind: prefix
          value: .tasks
          exclude: True  
        
      2:
        action: alias
        description: >-
          Alias newly created indices under logging alias
        options:
          name: logging
          warn_if_no_indices: False
          disable_action: False
          extra_settings:
            filter:
              term:
                kubernetes.namespace.keyword: logging
        add:
          filters:
          - filtertype: pattern
            kind: prefix
            value: containers-
            exclude:
          - filtertype: period
            period_type: relative
            source: name
            range_from: 0
            range_to: 0
            timestring: '%Y.%m.%d'
            unit: days
      3:
        action: alias
        description: >-
          Alias newly created indices under monitoring alias
        options:
          name: monitoring
          warn_if_no_indices: False
          disable_action: False
          extra_settings:
            filter:
              term:
                kubernetes.namespace.keyword: monitoring
        add:
          filters:
          - filtertype: pattern
            kind: prefix
            value: containers-
            exclude:
          - filtertype: period
            period_type: relative
            source: name
            range_from: 0
            range_to: 0
            timestring: '%Y.%m.%d'
            unit: days      
            

  curator.yml: |+
    ---
    # Remember, leave a key empty if there is no value.  None will be a string,
    # not a Python "NoneType"
    client:
      hosts:
        - ${ES_HOST}
      url_prefix:
      use_ssl: true
      certificate: /etc/root-ca.pem
      client_cert:
      client_key:
      ssl_no_validate: false
      username: {{ .Values.elasticsearch.user }}
      password: {{ .Values.elasticsearch.password }}
      timeout: 300
      master_only: false
      
    logging:
      loglevel: INFO
      logformat: default
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-curator
  labels:
{{- include "logging.labels" . | indent 2}}
spec:
  schedule: "10 0 * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
{{- include "logging.labels" . | indent 10}}            
            type: es-curator
        spec:
          {{- with .Values.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          containers:
          - name: es-curator
            image: {{ .Values.es_curator_image.image }}:{{ .Values.es_curator_image.imageTag }}
            env:
            - name: ES_HOST
              value: {{ include "esurl" . }}
            command: ["/curator/curator", "--config", "/config/curator.yml", "/config/actions.yml"]
            volumeMounts:
            - name: curator
              mountPath: "/config"
            - name: certificates
              mountPath: /etc/root-ca.pem
              subPath: root-ca.pem  
          restartPolicy: OnFailure
          volumes:
          - name: curator
            configMap:
              name: {{ .Release.Name }}-curator
          - name: certificates
            secret:
              secretName: {{ .Release.Name }}-certificates
{{- end }}              